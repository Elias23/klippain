[gcode_macro _USER_VARIABLES]
variable_startprint_actions: "bed_soak", "extruder_preheating", "chamber_soak", "clean", "tilt_calib", "z_offset", "custom1", "bedmesh", "extruder_heating", "purge", "clean", "primeline"
variable_exhaust_enabled: True
variable_exhaust_name: "exhaust"
gcode: # do not remove this line

[fan_generic exhaust]
pin: EXHAUST_FAN
max_power: 1.0
kick_start_time: 0.250
off_below: 0.30

[gcode_macro START_EXHAUST]
gcode:
    {% set SPEED = params.SPEED|default(1)|float %}
    {% set exhaust_name = printer["gcode_macro _USER_VARIABLES"].exhaust_name %}
    SET_FAN_SPEED FAN={exhaust_name} SPEED={SPEED}

[gcode_macro _MODULE_CUSTOM1]
gcode:
    {% set verbose = printer["gcode_macro _USER_VARIABLES"].verbose %}
    {% set exhaust_filter_speed = printer["gcode_macro _USER_VARIABLES"].exhaust_filter_speed|default(0.3)|float %}

    {% if verbose %}
      RESPOND MSG="Start exhaust fan."
    {% endif %}
    START_EXHAUST SPEED={exhaust_filter_speed}

[gcode_macro STOP_EXHAUST]
gcode:
    {% set exhaust_name = printer["gcode_macro _USER_VARIABLES"].exhaust_name %}
    SET_FAN_SPEED FAN={exhaust_name} SPEED=0


[delayed_gcode _STOP_EXHAUST_DELAYED]
gcode:
    STOP_EXHAUST